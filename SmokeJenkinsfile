node('master') {
    def date = new Date();
    def folder = date.format('MM-dd-yyyy-HH_mm_ss')


    ws(pwd() + '\\tests') {
        stage('Fetch Test SCM') {
            checkout changelog: false, poll: false, scm: [$class: 'GitSCM', branches: [
                [name: '*/master']
            ], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [
                [credentialsId: env.StashCredentialsId, url: 'ssh://git@bitbucket-ssh.uhub.biz:7999/vmlnaiqa/haas-qa-automation.git']
            ]];
        }

        stage("Run Tests") {
                        def javaHome = tool(name: 'JDK.1.8', type: 'jdk');
            withEnv(["JAVA_HOME=${javaHome}"]) {
                bat "mvn clean verify -Dmaven.test.failure.ignore=true -Dcucumber.options=\"--tags @SmokeTest\" -Durl=\"$url\""
            }
        }
    }
  
    stage('Copy Files') {
        bat '( ' + env.ToolRoboCopy + ' ".\\tests\\Reports" ".\\reports\\web\\' + folder + '" /MIR ) ^& IF %ERRORLEVEL% LEQ 4 exit /B 0'
    }


    stage('Keep Only 10 Reports') {
            powershell "Get-ChildItem .\\reports\\web -Directory | Sort-Object CreationTime -Descending | select-Object -Skip 10 | Remove-Item -Recurse -Force"
    }

    stage('Deploy Files') {
    writeFile file: 'deployfiles.ps1', text: '''
				$dir = "D:\\apps\\jenkins\\workspace\\Haas\\Haas-Prod-Smoke\\reports\\web\\"
                $latest = Get-ChildItem -Path $dir | Where-Object {$_.PSIsContainer} |  Sort-Object -Property name,ws -Descending | Select-Object -First 1
                $latest.name
                $folder = $dir + $latest
                $block = { robocopy $folder D:\\sites\\qa-reports.vmldev.com\\HaasProdSmoke\\cucumbertest\\$latest /e /MT:20 /w:1 /r:1  }
                $block2 = { robocopy $folder D:\\sites\\qa-reports.vmldev.com\\HaasProdSmoke\\cucumbertest\\latest /e /MT:20 /w:1 /r:1  }
				Invoke-Command -ScriptBlock $block
                Invoke-Command -ScriptBlock $block2'''
			bat env.ToolPowerShell + / -NonInteractive -ExecutionPolicy ByPass "& '${workspace}\\deployfiles.ps1'"/
	}

}